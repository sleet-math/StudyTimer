<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StudyTimer — Best Record</title>
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --text:#0b1220; --muted:#5a6272;
    --brand:#2b6ef6; --accent:#2ed27a; --danger:#ff4d4d; --shadow:0 6px 18px rgba(15,23,42,0.06);
    --card-border: rgba(15,23,42,0.04); --input-border: rgba(15,23,42,0.06);
  }
  body.dark{
    --bg:#0b1220; --panel:#0f1724; --text:#e6eef8; --muted:#94a3b8;
    --brand:#4f8cff; --accent:#34d399; --danger:#ff7b7b; --shadow:0 8px 30px rgba(2,6,23,0.6);
    --card-border: rgba(255,255,255,0.14); --input-border: rgba(255,255,255,0.18);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }
  .wrap{ max-width:1100px; margin:20px auto; padding:16px }
  header{ display:flex; align-items:center; justify-content:space-between; gap:12px }
  .logo{ display:flex; gap:12px; align-items:center }
  .dot{ width:12px;height:12px;border-radius:50%; background:linear-gradient(135deg,var(--brand),var(--accent)); box-shadow:0 4px 12px rgba(0,0,0,0.08) }
  nav a{ margin-right:8px; padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--text); background:rgba(15,23,42,0.02); }
  nav a.active{ background:linear-gradient(135deg, rgba(43,110,246,0.08), rgba(46,210,122,0.06)); }
  .card{ background:var(--panel); border-radius:12px; padding:12px; box-shadow:var(--shadow); border:1px solid var(--card-border); }
  .tiny{ font-size:12px; color:var(--muted); }
  .controls{ display:flex; gap:8px; align-items:center; margin-top:10px }
  .action-btn{ background:linear-gradient(135deg,var(--brand),#3b82f6); color:#fff; border:none; padding:8px 12px; border-radius:999px; cursor:pointer }
  .btn-ghost{ background:transparent; border:1px solid var(--card-border); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn-danger{ background:linear-gradient(135deg,var(--danger),#ff7b7b); color:#fff; padding:8px 12px; border:none; border-radius:10px; cursor:pointer }
  select#subjectSelect{ appearance:none; padding:10px 36px 10px 12px; border-radius:10px; border:1px solid var(--input-border); background:transparent; font-weight:700; min-width:180px; cursor:pointer; color:var(--text);} 
  .select-caret{ position:relative; margin-left:-44px; width:32px;height:32px; display:inline-flex;align-items:center;justify-content:center; pointer-events:none; color:var(--muted); }
  .notes-layout{ display:grid; grid-template-columns:300px 1fr; gap:12px; margin-top:12px; height: calc(100vh - 220px); min-height: 320px; }
  @media(max-width:880px){ .notes-layout{ grid-template-columns:1fr; height:auto } }
  .notes-list{ height:100%; overflow-y:auto; padding:8px; border-radius:10px; background: linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.01)); border:1px solid var(--card-border); }
  .note-editor{ display:flex; flex-direction:column; height:100%; padding:12px; box-sizing:border-box; border:1px solid var(--card-border); }
  .note-editor input{ margin-bottom:8px; padding:10px; border-radius:10px; border:1px solid var(--input-border); background:transparent; color:var(--text);} 
  .note-editor textarea{ flex:1 1 auto; width:100%; min-height:0; padding:12px; border-radius:10px; border:1px solid var(--input-border); background:transparent; resize:vertical; color:var(--text); }
  input:focus, textarea:focus, select:focus{ outline:none; box-shadow:0 0 0 4px rgba(59,110,246,0.08); border-color:var(--brand); }
  body.dark input:focus, body.dark textarea:focus, body.dark select:focus{ box-shadow:0 0 0 4px rgba(79,140,255,0.08); }
  .timer-big{ font-family:SFMono-Regular,Menlo,monospace; font-size:28px; margin-top:8px; color:var(--text); }
  .stats-wrap{ display:grid; grid-template-columns:360px 1fr; gap:12px; margin-top:12px; height: calc(100vh - 200px); }
  @media(max-width:1000px){ .stats-wrap{ grid-template-columns:1fr; height:auto } }
  .metric{ padding:12px; border-radius:10px; margin-bottom:10px; background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(255,255,255,0.02)); border:1px solid var(--card-border); }
  .metric .label{ font-size:13px; color:var(--muted) }
  .metric .value{ font-weight:700; font-size:18px; margin-top:6px }
  .streak-strong{ font-weight:900; font-size:18px; color:var(--brand); text-align:right; min-width:120px; }
  .streak-badge{ display:inline-flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:10px 14px; border-radius:14px; min-width:150px; box-shadow:var(--shadow); background:var(--panel); color:var(--text); border:1px solid var(--card-border); }
  .streak-badge .label{ font-size:12px; opacity:0.9; }
  .streak-badge .number{ font-weight:900; font-size:20px; line-height:1; }
  .streak-badge .sub{ font-size:11px; opacity:0.95; }
  .timeframe-select{ display:flex; gap:8px; align-items:center; }
  .select-pill{ padding:8px 10px; border-radius:999px; border:1px solid var(--card-border); background:transparent; cursor:pointer }
  .select-pill.active{ background: linear-gradient(135deg,var(--brand),#3b82f6); color:#fff; border-color:transparent }
  .legend{ margin-top:8px; display:flex; flex-direction:column; gap:8px }
  .legend-item{ display:flex; gap:8px; align-items:center }
  .color-box{ width:14px; height:14px; border-radius:4px }
  canvas{ width:100%; height:320px; display:block }
  .modal{ position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(2,6,23,0.5); display:flex; align-items:center; justify-content:center; z-index:1000 }
  .panel{ width:90%; max-width:900px; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div id="appTitle" style="font-weight:800">StudyTimer</div>
          <div id="appSubtitle" class="tiny">勉強時間の記録</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <nav>
          <a href="#timer" id="navTimer">Timer</a>
          <a href="#notes" id="navNotes">Notepad</a>
          <a href="#stats" id="navStats">Statistics</a>
        </nav>

        <div id="streakHeader" class="streak-strong" aria-live="polite" title="連続日数"></div>

        <select id="langSelect" class="btn-ghost" aria-label="言語選択" style="padding:6px 10px">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
        <button id="themeToggle" class="btn-ghost" title="テーマ切替">☀️</button>
      </div>
    </header>

    <main id="app"></main>

    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="exportAllBtn" class="btn-ghost">エクスポート</button>
      <button id="importBtn" class="btn-ghost">インポート</button>
      <input id="importFileInput" type="file" accept="application/json" style="display:none" />
    </div>

    <footer style="margin-top:12px" class="tiny" id="footerNote">データはブラウザの LocalStorage に保存されます。</footer>
  </div>

  <div id="previewModal" class="modal" style="display:none">
    <div class="panel card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="previewTitle" style="font-weight:700">プレビュー</div>
        <div style="display:flex;gap:8px">
          <button id="downloadPreviewBtn" class="btn-ghost">ダウンロード</button>
          <button id="closePreviewBtn" class="btn-ghost">閉じる</button>
        </div>
      </div>
      <pre id="previewContent">...</pre>
    </div>
  </div>

<script>
/* ========= StudyTimer — Final (Best Record) ========= */

/* i18n */
const STR = {
  ja: {
    appTitle: 'StudyTimer', appSubtitle: '勉強時間の記録', navTimer: 'タイマー', navNotes: 'ノート', navStats: '統計',
    export: 'エクスポート', import: 'インポート', preview: 'プレビュー', download: 'ダウンロード', close: '閉じる',
    timerHeading: '⏱ タイマー', timerHint: '科目をドロップダウンから選択して開始。停止でセッションが保存されます。', addSubjectPlaceholder: '科目を追加', addBtn: '追加', start: '開始', pause: '一時停止', resume: '再開', stopSave: '停止して保存',
    today: '今日', week: '今週', month: '今月', logTitle: '学習ログ', logDeleteConfirm: 'この記録を削除しますか？',
    noteHeading: '📝 メモ帳', noteSearchPlaceholder: '検索（タイトル / 本文）', newNote: '新規', noteTitlePlaceholder: 'タイトル', noteBodyPlaceholder: 'ここにメモを書く...', lastUpdated: '最終更新', saveNote: '保存', deleteNote: '削除', downloadNote: 'ダウンロード', deleteNoteConfirm: 'このノートを削除しますか？', savedAlert: '保存しました', importedAlert: 'インポートが完了しました', importFailed: 'インポートに失敗しました', invalidFile: '不正なファイルです', storageFooter: 'データはブラウザの LocalStorage に保存されます。',
    statsHeading: '📊 統計', statsBySubject: '科目別学習時間', statsDay: '前日比', statsWeek: '先週比', statsMonth: '先月比', statsNoData: 'セッションデータがまだありません', streakLabel: '連続日数', timeframeLabel: '集計期間'
  },
  en: {
    appTitle: 'StudyTimer', appSubtitle: 'Study time tracker', navTimer: 'Timer', navNotes: 'Notepad', navStats: 'Statistics',
    export: 'Export', import: 'Import', preview: 'Preview', download: 'Download', close: 'Close',
    timerHeading: '⏱ Timer', timerHint: 'Select a subject from the dropdown and start. Stop to save the session.', addSubjectPlaceholder: 'Add subject', addBtn: 'Add', start: 'Start', pause: 'Pause', resume: 'Resume', stopSave: 'Stop & Save',
    today: 'Today', week: 'Week', month: 'Month', logTitle: 'Study Log',
    noteHeading: '📝 Notepad', noteSearchPlaceholder: 'Search (title / body)', newNote: 'New', noteTitlePlaceholder: 'Title', noteBodyPlaceholder: 'Write your note here...', lastUpdated: 'Last updated', saveNote: 'Save', deleteNote: 'Delete', downloadNote: 'Download', deleteNoteConfirm: 'Delete this note?', savedAlert: 'Saved', importedAlert: 'Import completed', importFailed: 'Import failed', invalidFile: 'Invalid file', storageFooter: 'Data is saved to your browser LocalStorage.',
    statsHeading: '📊 Statistics', statsBySubject: 'Study time by subject', statsDay: 'Day vs Yesterday', statsWeek: 'Last 7 days vs prev 7 days', statsMonth: 'Month vs prev month', statsNoData: 'No session data yet', streakLabel: 'Streak', timeframeLabel: 'Timeframe'
  }
};

/* Keys & helpers */
const LOCALE_KEY = 'study_locale_pref';
const THEME_KEY = 'study_theme_pref';
const LAST_PAGE_KEY = 'study_last_page';
const LS_KEYS = { subjects:'study_subjects', sessions:'study_sessions', notes:'study_notes' };

function uid(){ return (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : ('id_'+Date.now()+'_'+Math.random().toString(36).slice(2)); }
function pad(n){ return String(n).padStart(2,'0'); }
function fmtHMS(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.max(0,sec%60); return pad(h)+':'+pad(m)+':'+pad(s); }
function formatHoursNice(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); if(h>0) return h+'h '+m+'m'; if(m>0) return m+'m'; return sec+'s'; }

function toLocalDateKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function loadJSON(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
}
function saveJSON(key, value){
  try{ localStorage.setItem(key, JSON.stringify(value)); } catch(e){}
}

/* State */
let locale = localStorage.getItem(LOCALE_KEY) || 'ja';
let subjects = loadJSON(LS_KEYS.subjects, ['数学','英語','理科','社会','国語']);
let sessions = loadJSON(LS_KEYS.sessions, []);
let notes = loadJSON(LS_KEYS.notes, [{ id: uid(), title:(locale==='ja'?'はじめのノート':'Starter note'), body:(locale==='ja'?'ここはメモです。':'This is a note.'), updatedISO:new Date().toISOString() }]);

/* DOM refs */
const app = document.getElementById('app');
const navTimer = document.getElementById('navTimer');
const navNotes = document.getElementById('navNotes');
const navStats = document.getElementById('navStats');
const exportAllBtn = document.getElementById('exportAllBtn');
const importBtn = document.getElementById('importBtn');
const importFileInput = document.getElementById('importFileInput');
const previewModal = document.getElementById('previewModal');
const previewContent = document.getElementById('previewContent');
const closePreviewBtn = document.getElementById('closePreviewBtn');
const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
const themeToggleBtn = document.getElementById('themeToggle');
const langSelect = document.getElementById('langSelect');
const appTitleEl = document.getElementById('appTitle');
const appSubtitleEl = document.getElementById('appSubtitle');
const previewTitleEl = document.getElementById('previewTitle');
const footerNoteEl = document.getElementById('footerNote');
const streakHeader = document.getElementById('streakHeader');

/* Locale & theme */
function applyLocale(l){
  locale = l; localStorage.setItem(LOCALE_KEY, l);
  appTitleEl.textContent = STR[l].appTitle;
  appSubtitleEl.textContent = STR[l].appSubtitle;
  navTimer.textContent = STR[l].navTimer;
  navNotes.textContent = STR[l].navNotes;
  navStats.textContent = STR[l].navStats;
  exportAllBtn.textContent = STR[l].export;
  importBtn.textContent = STR[l].import;
  previewTitleEl.textContent = STR[l].preview;
  closePreviewBtn.textContent = STR[l].close;
  footerNoteEl.textContent = STR[l].storageFooter || STR[l].storageFooter;
}
langSelect.value = locale;
langSelect.addEventListener('change', ()=> applyLocale(langSelect.value));

function applyTheme(theme){
  if(theme === 'dark'){ document.body.classList.add('dark'); themeToggleBtn.textContent = '🌙'; }
  else { document.body.classList.remove('dark'); themeToggleBtn.textContent = '☀️'; }
  localStorage.setItem(THEME_KEY, theme);
}
(function initTheme(){ const pref = localStorage.getItem(THEME_KEY) || 'light'; applyTheme(pref); })();
themeToggleBtn.addEventListener('click', ()=> applyTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

/* Export / Import */
function buildExportPayload(){ return { exportedAt:new Date().toISOString(), subjects, sessions, notes }; }
function downloadJson(filename, text){
  const blob = new Blob([text], { type:'application/json' }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
}
exportAllBtn.addEventListener('click', ()=> downloadJson('study_data_export_' + (new Date().toISOString().slice(0,10)) + '.json', JSON.stringify(buildExportPayload(), null, 2)));
importBtn.addEventListener('click', ()=> importFileInput.click());
importFileInput.addEventListener('change', (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const d = JSON.parse(reader.result);
      if(Array.isArray(d.subjects)){ d.subjects.forEach(s=>{ if(!subjects.includes(s)) subjects.unshift(s); }); saveJSON(LS_KEYS.subjects, subjects); }
      if(Array.isArray(d.sessions)){ const map = {}; sessions.forEach(s=> map[s.id]=s); d.sessions.forEach(s=>{ if(!s.id) s.id = uid(); map[s.id] = s; }); sessions = Object.keys(map).map(k=> map[k]); sessions.sort((a,b)=> new Date(b.startISO) - new Date(a.startISO)); saveJSON(LS_KEYS.sessions, sessions); }
      if(Array.isArray(d.notes)){ const map2={}; notes.forEach(n=> map2[n.id]=n); d.notes.forEach(n=>{ if(!n.id) n.id = uid(); map2[n.id]=n; }); notes = Object.keys(map2).map(k=> map2[k]); notes.sort((a,b)=> new Date(b.updatedISO) - new Date(a.updatedISO)); saveJSON(LS_KEYS.notes, notes); }
      alert(STR[locale].importedAlert || 'Import completed'); route();
    }catch(e){ console.error(e); alert(STR[locale].importFailed || 'Import failed'); }
  };
  reader.readAsText(f);
  importFileInput.value = '';
});

/* Stats helpers */
function sumOnDate(arr, dateKey){
  let s=0;
  for(let i=0;i<arr.length;i++){ if(arr[i].dateKey === dateKey) s += arr[i].seconds||0; }
  return s;
}
function sumByDateKey(arr){
  const map = {};
  arr.forEach(s=>{
    let k = s.dateKey;
    if(!k && s.startISO) k = toLocalDateKey(new Date(s.startISO));
    if(!k) return;
    map[k] = (map[k]||0) + (s.seconds||0);
  });
  return map;
}
function secondsPerSubjectInRange(arr, daysBack){
  const cutoff = new Date(); cutoff.setHours(0,0,0,0); cutoff.setDate(cutoff.getDate() - (daysBack-1));
  const map = {};
  arr.forEach(s=>{
    const k = s.dateKey || (s.startISO? toLocalDateKey(new Date(s.startISO)) : null);
    if(!k) return;
    if(new Date(k) >= cutoff){
      const subj = s.subject || '(No subject)';
      map[subj] = (map[subj]||0) + (s.seconds||0);
    }
  });
  return map;
}

/* calcComparisons with maxStreak calculation */
function calcComparisons(){
  const today = new Date(); today.setHours(0,0,0,0);
  const todayKey = toLocalDateKey(today);
  const yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
  const yesterdayKey = toLocalDateKey(yesterday);

  const dayTotal = sumOnDate(sessions, todayKey);
  const prevDayTotal = sumOnDate(sessions, yesterdayKey);

  function totalsForNDaysUntil(endDateKey, n){
    const end = new Date(endDateKey + 'T00:00:00');
    let sum = 0;
    for(let i=0;i<n;i++){
      const d = new Date(end); d.setDate(end.getDate()-i);
      const k = toLocalDateKey(d);
      sum += sumOnDate(sessions, k);
    }
    return sum;
  }
  const last7Sum = totalsForNDaysUntil(todayKey, 7);
  const prev7End = new Date(today); prev7End.setDate(prev7End.getDate()-7);
  const prev7Key = toLocalDateKey(prev7End);
  const prev7Sum = totalsForNDaysUntil(prev7Key, 7);

  const now = new Date(today);
  const thisMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
  const prevMonthKey = `${prev.getFullYear()}-${String(prev.getMonth()+1).padStart(2,'0')}`;

  function sumMonth(key){
    let s=0;
    for(let i=0;i<sessions.length;i++){
      if(String(sessions[i].dateKey).indexOf(key)===0) s += sessions[i].seconds||0;
    }
    return s;
  }
  const thisMonthSum = sumMonth(thisMonthKey);
  const prevMonthSum = sumMonth(prevMonthKey);

  const map = sumByDateKey(sessions);

  function streakFrom(dateObj){
    let cnt = 0;
    const d = new Date(dateObj);
    while(true){
      const k = toLocalDateKey(d);
      if((map[k]||0) > 0){ cnt++; d.setDate(d.getDate()-1); } else break;
    }
    return cnt;
  }

  // compute max streak historically by checking streak ending on any date with data
  let maxStreak = 0;
  const keys = Object.keys(map).slice().sort();
  for(let i=0;i<keys.length;i++){
    const k = keys[i];
    const d = new Date(k + 'T00:00:00');
    const s = streakFrom(d);
    if(s > maxStreak) maxStreak = s;
  }

  const streakIncludingToday = streakFrom(today);
  const streakExcludingToday = streakFrom(yesterday);
  const hasToday = (map[todayKey]||0) > 0;
  const hasYesterday = (map[yesterdayKey]||0) > 0;

  return {
    dayTotal, prevDayTotal, last7Sum, prev7Sum, thisMonthSum, prevMonthSum,
    streak: streakIncludingToday,
    streakBefore: streakExcludingToday,
    hasToday,
    hasYesterday,
    maxStreak
  };
}

/* drawPie (same as before) */
function colorForIndex(i){ return `hsl(${(i*47)%360} 70% 55%)`; }
function drawPie(canvas, dataMap){
  const ctx = canvas.getContext('2d'); const dpi = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w * dpi); canvas.height = Math.floor(h * dpi);
  ctx.setTransform(dpi,0,0,dpi,0,0); ctx.clearRect(0,0,w,h);
  const entries = Object.keys(dataMap).map(k=>({k,v:dataMap[k]})).filter(e=>e.v>0);
  const total = entries.reduce((a,b)=> a + b.v, 0);
  if(entries.length === 0 || total === 0){
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted') || '#889';
    ctx.font = '14px system-ui'; ctx.textAlign = 'center'; ctx.fillText(STR[locale].statsNoData, w/2, h/2);
    return { legend: [] };
  }
  const cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 10;
  let start = -Math.PI/2; const legend = [];
  entries.forEach((e,i)=>{
    const slice = e.v / total * Math.PI * 2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy, r, start, start + slice); ctx.closePath();
    ctx.fillStyle = colorForIndex(i); ctx.fill();
    legend.push({ label:e.k, value:e.v, color: colorForIndex(i), percent: Math.round(e.v/total*1000)/10 });
    start += slice;
  });
  ctx.fillStyle = document.body.classList.contains('dark') ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.75)';
  ctx.font='bold 14px system-ui'; ctx.textAlign='center'; ctx.fillText(formatHoursNice(total), cx, cy);
  return { legend, total };
}

/* Timer page (unchanged except for using calcComparisons/updateHeaderStreak) */
function renderTimerPage(){
  document.title = `${STR[locale].appTitle} — ${STR[locale].navTimer}`;
  navTimer.classList.add('active'); navNotes.classList.remove('active'); navStats.classList.remove('active');

  app.innerHTML = `
    <section class="card">
      <h2>${STR[locale].timerHeading}</h2>
      <p class="tiny">${STR[locale].timerHint}</p>
      <div style="margin-top:12px;display:flex;align-items:center;gap:12px;">
        <div class="subject-select-wrap">
          <select id="subjectSelect" aria-label="科目選択"></select>
          <span class="select-caret">▾</span>
          <input id="newSubjectInput" type="text" placeholder="${STR[locale].addSubjectPlaceholder}" style="padding:8px;border-radius:8px;border:1px solid var(--input-border);background:transparent;color:inherit" />
          <button id="addSubjectBtn" class="btn-ghost">${STR[locale].addBtn}</button>
        </div>
      </div>
      <div class="controls">
        <button id="startBtn" class="action-btn">${STR[locale].start}</button>
        <button id="pauseBtn" class="btn-ghost" disabled>${STR[locale].pause}</button>
        <button id="stopBtn" class="btn-danger" disabled>${STR[locale].stopSave}</button>
      </div>
      <div style="margin-top:18px" class="timer-big" id="timerDisplay">00:00:00</div>
      <div style="margin-top:12px;display:flex;gap:12px;">
        <div class="card" style="flex:1"><div class="tiny">${STR[locale].today}</div><div id="todayTotal">0:00</div></div>
        <div class="card" style="flex:1"><div class="tiny">${STR[locale].week}</div><div id="weekTotal">0:00</div></div>
        <div class="card" style="flex:1"><div class="tiny">${STR[locale].month}</div><div id="monthTotal">0:00</div></div>
      </div>
      <div style="margin-top:16px"><h3>📒 ${STR[locale].logTitle}</h3>
        <div class="card" style="margin-top:8px">
          <table id="logTable" style="width:100%;border-collapse:collapse">
            <thead><tr><th style="text-align:left">日付</th><th>開始</th><th>終了</th><th>科目</th><th>時間</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  `;

  const subjectSelect = document.getElementById('subjectSelect');
  const newSubjectInput = document.getElementById('newSubjectInput');
  const addSubjectBtn = document.getElementById('addSubjectBtn');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const todayTotalEl = document.getElementById('todayTotal');
  const weekTotalEl = document.getElementById('weekTotal');
  const monthTotalEl = document.getElementById('monthTotal');
  const logTableBody = document.querySelector('#logTable tbody');

  function populateSubjectSelect(){ subjectSelect.innerHTML = ''; subjects.forEach(s=>{ const opt = document.createElement('option'); opt.value=s; opt.textContent=s; subjectSelect.appendChild(opt); }); if(subjects.length) subjectSelect.value = subjects[0]; }
  populateSubjectSelect();

  let currentSubject = subjectSelect.value || subjects[0] || '';
  subjectSelect.addEventListener('change', ()=> currentSubject = subjectSelect.value);

  addSubjectBtn.addEventListener('click', ()=>{
    const v = (newSubjectInput.value||'').trim(); if(!v) return;
    if(subjects.includes(v)){ alert(locale==='ja'?'既に存在します':'Already exists'); return; }
    subjects.unshift(v); saveJSON(LS_KEYS.subjects, subjects); newSubjectInput.value=''; populateSubjectSelect(); currentSubject = v;
  });

  let ticking=false, paused=false, startAt=null, accSec=0, tickHandle=null;
  function setButtons(){ startBtn.disabled=ticking; pauseBtn.disabled=!ticking; stopBtn.disabled=!ticking; pauseBtn.textContent = paused ? STR[locale].resume : STR[locale].pause; }
  function tick(){ const now=new Date(); const elapsed = Math.floor((now - startAt)/1000) + accSec; const td = document.getElementById('timerDisplay'); if(td) td.textContent = fmtHMS(elapsed); }

  startBtn.addEventListener('click', ()=>{
    currentSubject = subjectSelect.value; if(!currentSubject){ alert(locale==='ja'?'科目を選択してください':'Please select a subject'); return; }
    ticking=true; paused=false; startAt=new Date(); accSec=0; clearInterval(tickHandle); tickHandle=setInterval(tick,1000); tick(); setButtons(); updateHeaderStreak();
  });
  pauseBtn.addEventListener('click', ()=>{
    if(!ticking) return;
    if(!paused){ const now=new Date(); accSec += Math.floor((now - startAt)/1000); paused=true; clearInterval(tickHandle); }
    else { startAt=new Date(); paused=false; tick(); tickHandle=setInterval(tick,1000); }
    setButtons();
  });
  stopBtn.addEventListener('click', ()=>{
    if(!ticking) return;
    const end = new Date(); const seconds = Math.max(1, paused ? accSec : accSec + Math.floor((end - startAt)/1000));
    const startISO = new Date(end - seconds*1000).toISOString();
    const entry = { id: uid(), subject: currentSubject, seconds, startISO, endISO: end.toISOString(), dateKey: toLocalDateKey(new Date(startISO)) };
    sessions.push(entry); saveJSON(LS_KEYS.sessions, sessions);
    ticking=false; paused=false; startAt=null; accSec=0; clearInterval(tickHandle); timerDisplay.textContent='00:00:00'; setButtons(); updateKpis(); renderLog();
    alert(locale==='ja'?'記録しました':'Saved'); updateHeaderStreak();
  });

  function sumToday(){ const td = toLocalDateKey(new Date()); let t=0; sessions.forEach(s=>{ if(s.dateKey === td) t += s.seconds||0; }); return t; }
  function sumLastNDays(n){ const now=new Date(); const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate()-n+1); let t=0; sessions.forEach(s=>{ if(new Date(s.dateKey) >= cutoff) t += s.seconds||0; }); return t; }
  function sumThisMonth(){ const now=new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; let t=0; sessions.forEach(s=>{ if(String(s.dateKey).indexOf(ym)===0) t += s.seconds||0; }); return t; }
  function fmtHM(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60); return h+':'+pad(m); }
  function updateKpis(){ if(todayTotalEl) todayTotalEl.textContent = fmtHM(sumToday()); if(weekTotalEl) weekTotalEl.textContent = fmtHM(sumLastNDays(7)); if(monthTotalEl) monthTotalEl.textContent = fmtHM(sumThisMonth()); }

  function renderLog(){
    logTableBody.innerHTML = '';
    const rows = sessions.slice().sort((a,b)=> new Date(b.startISO) - new Date(a.startISO));
    rows.forEach(e=>{
      const dStart = new Date(e.startISO), dEnd = new Date(e.endISO);
      const tr = document.createElement('tr');
      const fmtTime = d => pad(d.getHours()) + ':' + pad(d.getMinutes());
      const fmtDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      tr.innerHTML = `<td>${fmtDate(dStart)}</td><td>${fmtTime(dStart)}</td><td>${fmtTime(dEnd)}</td><td>${e.subject||''}</td><td>${fmtHMS(e.seconds)}</td><td><button class="btn-ghost" type="button" data-id="${e.id}">🗑 ${locale==='ja'?'削除':'Delete'}</button></td>`;
      const delBtn = tr.querySelector('button');
      delBtn.addEventListener('click', ()=>{
        if(!confirm(STR[locale].logDeleteConfirm)) return;
        sessions = sessions.filter(s=> s.id !== e.id);
        saveJSON(LS_KEYS.sessions, sessions);
        renderLog(); updateKpis(); updateHeaderStreak();
      });
      logTableBody.appendChild(tr);
    });
  }

  updateKpis(); renderLog(); setButtons(); updateHeaderStreak();
}

/* Notes page (unchanged) */
function renderNotesPage(){
  document.title = `${STR[locale].appTitle} — ${STR[locale].navNotes}`;
  navTimer.classList.remove('active'); navNotes.classList.add('active'); navStats.classList.remove('active');

  app.innerHTML = `
    <section class="card">
      <h2>📝 ${STR[locale].noteHeading}</h2>
      <p class="tiny">左でノートを選択、右で編集します。自動保存あり。</p>
      <div class="notes-layout">
        <div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="noteSearch" placeholder="${STR[locale].noteSearchPlaceholder}" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--input-border);background:transparent;color:inherit" />
            <button id="newNoteBtn" class="btn-ghost">${STR[locale].newNote}</button>
          </div>
          <div class="notes-list" id="notesList"></div>
        </div>
        <div class="note-editor card">
          <input id="noteTitle" placeholder="${STR[locale].noteTitlePlaceholder}" aria-label="ノートタイトル" />
          <textarea id="noteBody" placeholder="${STR[locale].noteBodyPlaceholder}"></textarea>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div class="tiny">${STR[locale].lastUpdated}: <span id="noteUpdated">—</span></div>
            <div style="display:flex;gap:8px">
              <button id="saveNoteBtn" class="btn-ghost">${STR[locale].saveNote}</button>
              <button id="previewNoteBtn" class="btn-ghost">${STR[locale].preview}</button>
              <button id="downloadNoteBtn" class="btn-ghost">${STR[locale].download}</button>
              <button id="deleteNoteBtn" class="btn-danger">${STR[locale].deleteNote}</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  `;

  const notesListEl = document.getElementById('notesList');
  const noteTitleEl = document.getElementById('noteTitle');
  const noteBodyEl = document.getElementById('noteBody');
  const noteUpdatedEl = document.getElementById('noteUpdated');
  const newNoteBtn = document.getElementById('newNoteBtn');
  const saveNoteBtn = document.getElementById('saveNoteBtn');
  const deleteNoteBtn = document.getElementById('deleteNoteBtn');
  const downloadNoteBtn = document.getElementById('downloadNoteBtn');
  const previewNoteBtn = document.getElementById('previewNoteBtn');
  const noteSearch = document.getElementById('noteSearch');

  let currentNoteId = notes.length ? notes[0].id : null;
  let saveTimer = null;

  function saveNotesToStorage(){ saveJSON(LS_KEYS.notes, notes); }

  function renderNotesList(filter){
    filter = (filter||'').toLowerCase();
    notesListEl.innerHTML = '';
    const sorted = notes.slice().sort((a,b)=> new Date(b.updatedISO) - new Date(a.updatedISO));
    sorted.forEach(n=>{
      if(filter){
        const hay = (n.title + '\n' + n.body).toLowerCase();
        if(hay.indexOf(filter) === -1) return;
      }
      const item = document.createElement('div');
      item.className = 'note-item' + (n.id === currentNoteId ? ' active' : '');
      item.setAttribute('role','listitem');
      const meta = document.createElement('div'); meta.className = 'note-meta';
      const t = document.createElement('div'); t.className = 'note-title'; t.textContent = n.title || (locale==='ja'?'(タイトルなし)':'(Untitled)');
      const u = document.createElement('div'); u.className = 'note-upd'; u.textContent = (new Date(n.updatedISO)).toLocaleString();
      meta.appendChild(t); meta.appendChild(u);
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      const openBtn = document.createElement('button'); openBtn.className='btn-ghost'; openBtn.textContent = (locale==='ja'?'開く':'Open');
      openBtn.addEventListener('click', ()=> selectNote(n.id));
      const delBtn = document.createElement('button'); delBtn.className='btn-ghost'; delBtn.textContent = '×';
      delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(!confirm(STR[locale].deleteNoteConfirm)) return; notes = notes.filter(x=> x.id !== n.id); if(currentNoteId === n.id) currentNoteId = notes.length ? notes[0].id : null; saveNotesToStorage(); renderNotesList(noteSearch.value); renderNoteEditor(); });
      right.appendChild(openBtn); right.appendChild(delBtn);
      item.appendChild(meta); item.appendChild(right);
      item.addEventListener('click', ()=> selectNote(n.id));
      notesListEl.appendChild(item);
    });
  }

  function selectNote(id){ currentNoteId = id; renderNotesList(noteSearch.value); renderNoteEditor(); }
  function renderNoteEditor(){
    const n = notes.find(x=> x.id === currentNoteId);
    if(!n){ noteTitleEl.value = ''; noteBodyEl.value=''; noteUpdatedEl.textContent='—'; return; }
    noteTitleEl.value = n.title || '';
    noteBodyEl.value = n.body || '';
    noteUpdatedEl.textContent = new Date(n.updatedISO).toLocaleString();
  }
  function createNewNote(){ const n = { id: uid(), title: (locale==='ja'?'新規ノート':'New note'), body:'', updatedISO: new Date().toISOString() }; notes.unshift(n); currentNoteId = n.id; saveNotesToStorage(); renderNotesList(); renderNoteEditor(); }
  function saveCurrentNote(){ if(!currentNoteId) return; const n = notes.find(x=> x.id === currentNoteId); if(!n) return; n.title = (noteTitleEl.value||'').trim(); n.body = noteBodyEl.value || ''; n.updatedISO = new Date().toISOString(); saveJSON(LS_KEYS.notes, notes); renderNotesList(noteSearch.value); renderNoteEditor(); }
  function deleteCurrentNote(){ if(!currentNoteId) return; if(!confirm(STR[locale].deleteNoteConfirm)) return; notes = notes.filter(x=> x.id !== currentNoteId); currentNoteId = notes.length ? notes[0].id : null; saveNotesToStorage(); renderNotesList(noteSearch.value); renderNoteEditor(); }
  function downloadCurrentNote(){ const n = notes.find(x=> x.id === currentNoteId); if(!n) return; const blob = new Blob([n.title + '\n\n' + n.body], {type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (n.title||'note') + '.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(url), 1000); }

  function scheduleAutosave(){ if(saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(()=> saveCurrentNote(), 1000); }

  newNoteBtn.addEventListener('click', createNewNote);
  saveNoteBtn.addEventListener('click', ()=> { saveCurrentNote(); alert(STR[locale].savedAlert); });
  deleteNoteBtn.addEventListener('click', deleteCurrentNote);
  downloadNoteBtn.addEventListener('click', downloadCurrentNote);
  previewNoteBtn.addEventListener('click', ()=>{
    const n = notes.find(x=> x.id === currentNoteId);
    if(!n) return alert(locale==='ja'?'ノートが選択されていません':'No note selected');
    previewContent.textContent = `--- ${n.title || (locale==='ja'?'(タイトル無し)':'(Untitled)')} ---\n\n${n.body}`;
    previewModal.style.display = 'flex'; previewModal.setAttribute('aria-hidden','false');
    downloadPreviewBtn.onclick = ()=>{
      const data = previewContent.textContent;
      const blob = new Blob([data], {type:'text/plain'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (n.title||'note') + '.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(url), 1000);
    };
  });

  noteSearch.addEventListener('input', ()=> renderNotesList(noteSearch.value));
  noteTitleEl.addEventListener('input', scheduleAutosave);
  noteBodyEl.addEventListener('input', scheduleAutosave);
  window.addEventListener('keydown', (e)=> { if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveCurrentNote(); alert(STR[locale].savedAlert); } });

  renderNotesList(); renderNoteEditor();
}

/* Stats page (unchanged except header update) */
function renderStatsPage(){
  document.title = `${STR[locale].appTitle} — ${STR[locale].navStats}`;
  navTimer.classList.remove('active'); navNotes.classList.remove('active'); navStats.classList.add('active');

  app.innerHTML = `
    <section class="card">
      <h2>${STR[locale].statsHeading}</h2>
      <div class="stats-wrap">
        <div class="left-panel">
          <div class="metric"><div class="label">${STR[locale].statsDay}</div><div class="value" id="cmpDay">—</div><div class="tiny" id="cmpDayPct"></div></div>
          <div class="metric"><div class="label">${STR[locale].statsWeek}</div><div class="value" id="cmpWeek">—</div><div class="tiny" id="cmpWeekPct"></div></div>
          <div class="metric"><div class="label">${STR[locale].statsMonth}</div><div class="value" id="cmpMonth">—</div><div class="tiny" id="cmpMonthPct"></div></div>
        </div>
        <div class="right-panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="tiny">${STR[locale].timeframeLabel}</div>
            <div class="timeframe-select"><button class="select-pill active" data-range="7">1W</button><button class="select-pill" data-range="30">1M</button><button class="select-pill" data-range="365">1Y</button></div>
          </div>
          <canvas id="pieCanvas"></canvas>
          <div id="pieLegend" class="legend"></div>
        </div>
      </div>
    </section>
  `;

  const cmpDay = document.getElementById('cmpDay'), cmpDayPct = document.getElementById('cmpDayPct');
  const cmpWeek = document.getElementById('cmpWeek'), cmpWeekPct = document.getElementById('cmpWeekPct');
  const cmpMonth = document.getElementById('cmpMonth'), cmpMonthPct = document.getElementById('cmpMonthPct');
  const pieCanvas = document.getElementById('pieCanvas'), pieLegend = document.getElementById('pieLegend');
  const pills = Array.from(document.querySelectorAll('.select-pill'));
  let activeRange = 7;

  function computeAndRender(){
    const c = calcComparisons();
    cmpDay.textContent = formatHoursNice(c.dayTotal);
    if(c.prevDayTotal === 0){ cmpDayPct.textContent = (c.dayTotal === 0 ? (locale==='ja'?'前日: 0':'No change') : (locale==='ja'?'前日データがないため比較不可':'N/A (no prev)')); }
    else { const diff = c.dayTotal - c.prevDayTotal; const pct = Math.round((diff/c.prevDayTotal)*100); cmpDayPct.textContent = (diff>=0?'▲':'▼') + formatHoursNice(Math.abs(diff)) + ' (' + (pct>=0? '+'+pct : pct) + '%)'; }

    cmpWeek.textContent = formatHoursNice(c.last7Sum);
    if(c.prev7Sum === 0){ cmpWeekPct.textContent = (c.last7Sum===0 ? (locale==='ja'?'先週: 0':'No change') : (locale==='ja'?'先週データがないため比較不可':'N/A (no prev)')); }
    else { const diffW = c.last7Sum - c.prev7Sum; const pctW = Math.round((diffW/c.prev7Sum)*100); cmpWeekPct.textContent = (diffW>=0?'▲':'▼') + formatHoursNice(Math.abs(diffW)) + ' (' + (pctW>=0? '+'+pctW : pctW) + '%)'; }

    cmpMonth.textContent = formatHoursNice(c.thisMonthSum);
    if(c.prevMonthSum === 0){ cmpMonthPct.textContent = (c.thisMonthSum===0 ? (locale==='ja'?'先月: 0':'No change') : (locale==='ja'?'先月データがないため比較不可':'N/A (no prev)')); }
    else { const diffM = c.thisMonthSum - c.prevMonthSum; const pctM = Math.round((diffM/c.prevMonthSum)*100); cmpMonthPct.textContent = (diffM>=0?'▲':'▼') + formatHoursNice(Math.abs(diffM)) + ' (' + (pctM>=0? '+'+pctM : pctM) + '%)'; }

    const data = secondsPerSubjectInRange(sessions, activeRange);
    const res = drawPie(pieCanvas, data);
    pieLegend.innerHTML = '';
    (res.legend || []).forEach(it=>{
      const row = document.createElement('div'); row.className = 'legend-item';
      const cbox = document.createElement('span'); cbox.className = 'color-box'; cbox.style.background = it.color;
      const txt = document.createElement('div'); txt.textContent = `${it.label} — ${formatHoursNice(it.value)} (${it.percent}%)`;
      row.appendChild(cbox); row.appendChild(txt); pieLegend.appendChild(row);
    });

    updateHeaderStreak();
  }

  function setActiveRange(range){ activeRange = range; pills.forEach(p=> p.classList.toggle('active', Number(p.dataset.range) === range)); computeAndRender(); }
  pills.forEach(p=> p.addEventListener('click', ()=> setActiveRange(Number(p.dataset.range))));

  computeAndRender();
  window.addEventListener('resize', ()=> { const cvs = document.getElementById('pieCanvas'); if(cvs) drawPie(cvs, secondsPerSubjectInRange(sessions, activeRange)); });
}

/* Header streak UI: show best-record (最高記録) instead of last-study */
function updateHeaderStreak(){
  const c = calcComparisons();
  const label = STR[locale].streakLabel || (locale==='ja' ? '連続日数' : 'Streak');

  let displayCount = 0;
  if(c.hasToday){
    displayCount = c.streak;
  } else if(!c.hasToday && c.hasYesterday){
    displayCount = c.streakBefore;
  } else {
    displayCount = 0;
  }

  const best = c.maxStreak || 0;
  const subtitle = c.hasToday ? (locale==='ja' ? '今日学習済み' : 'Studied today') : (locale==='ja' ? ('最高記録: ' + best + '日') : ('Best: ' + best + ' days'));

  const numberColor = c.hasToday ? 'var(--brand)' : 'var(--danger)';
  const html = `
    <div class="streak-badge" role="status" aria-live="polite" title="${label}">
      <div class="label">${label}</div>
      <div class="number" style="color:${numberColor}">${displayCount}</div>
      <div class="sub">${subtitle}</div>
    </div>
  `;
  streakHeader.innerHTML = html;
}

/* Router */
function saveLastPage(p){ try{ localStorage.setItem(LAST_PAGE_KEY, p); }catch(e){} }
function getLastPage(){ try{ return localStorage.getItem(LAST_PAGE_KEY) || 'timer'; }catch(e){ return 'timer'; } }

function route(){
  const defaultPage = getLastPage() || 'timer';
  const hash = (location.hash || ('#' + defaultPage)).replace('#','');
  if(hash === 'notes') renderNotesPage();
  else if(hash === 'stats') renderStatsPage();
  else renderTimerPage();
  saveLastPage(hash);
  updateHeaderStreak();
}

navTimer.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='timer'; saveLastPage('timer'); route(); updateHeaderStreak(); });
navNotes.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='notes'; saveLastPage('notes'); route(); updateHeaderStreak(); });
navStats.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='stats'; saveLastPage('stats'); route(); updateHeaderStreak(); });

previewModal.addEventListener('click', (ev)=>{ if(ev.target === previewModal){ previewModal.style.display='none'; previewModal.setAttribute('aria-hidden','true'); } });
closePreviewBtn.addEventListener('click', ()=> { previewModal.style.display='none'; previewModal.setAttribute('aria-hidden','true'); });

/* Init */
(function init(){
  langSelect.value = locale;
  applyLocale(locale);
  if(!location.hash) location.hash = getLastPage() || 'timer';
  route();
  updateHeaderStreak();
  console.log('StudyTimer with Best Record initialized');
})();
</script>
</body>
</html>
